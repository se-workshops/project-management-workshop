# 基本設計書

## 1. システム構成

### 1.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント（ブラウザ）                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              React SPA アプリケーション                │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │  Pages   │ │Components│ │  Hooks   │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  │  ┌──────────────────────────────────────┐          │   │
│  │  │         State Management             │          │   │
│  │  │      (React Context / useState)      │          │   │
│  │  └──────────────────────────────────────┘          │   │
│  │  ┌──────────────────────────────────────┐          │   │
│  │  │         i18n (react-i18next)         │          │   │
│  │  │      Translation / Locale Management │          │   │
│  │  └──────────────────────────────────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                     HTTP REST API                           │
│                            │                                │
└────────────────────────────┼────────────────────────────────┘
                             │
┌────────────────────────────┼────────────────────────────────┐
│                      サーバーサイド                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Express.js サーバー                      │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐            │   │
│  │  │  Routes  │ │Controllers│ │ Services │            │   │
│  │  └──────────┘ └──────────┘ └──────────┘            │   │
│  │  ┌──────────────────────────────────────┐          │   │
│  │  │       In-Memory Data Store           │          │   │
│  │  │    (ダミーデータ / ランタイムデータ)    │          │   │
│  │  │    (多言語商品データ含む)              │          │   │
│  │  └──────────────────────────────────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|-----------|
| フロントエンド | React | 18.x |
| ルーティング | React Router | 6.x |
| **多言語対応** | **react-i18next** | **14.x** |
| **i18nコア** | **i18next** | **23.x** |
| スタイリング | CSS Modules / Tailwind CSS | - |
| HTTP通信 | Fetch API / Axios | - |
| バックエンド | Node.js + Express.js | 20.x / 4.x |
| ビルドツール | Vite | 5.x |

---

## 2. フロントエンド設計

### 2.1 ディレクトリ構成

```
src/
├── components/          # 再利用可能なUIコンポーネント
│   ├── common/          # 汎用コンポーネント
│   │   ├── Button.jsx
│   │   ├── Input.jsx
│   │   ├── Modal.jsx
│   │   ├── Loading.jsx
│   │   └── LanguageSwitcher.jsx  # 🆕 言語切り替えコンポーネント
│   ├── layout/          # レイアウトコンポーネント
│   │   ├── Header.jsx
│   │   ├── Footer.jsx
│   │   └── Sidebar.jsx
│   ├── product/         # 商品関連コンポーネント
│   │   ├── ProductCard.jsx
│   │   ├── ProductList.jsx
│   │   └── ProductFilter.jsx
│   └── cart/            # カート関連コンポーネント
│       ├── CartItem.jsx
│       └── CartSummary.jsx
├── pages/               # ページコンポーネント
│   ├── LoginPage.jsx
│   ├── ProductListPage.jsx
│   ├── ProductDetailPage.jsx
│   ├── CartPage.jsx
│   ├── CheckoutPage.jsx
│   ├── OrderCompletePage.jsx
│   └── OrderHistoryPage.jsx
├── hooks/               # カスタムフック
│   ├── useAuth.js
│   ├── useCart.js
│   ├── useProducts.js
│   └── useLocale.js     # 🆕 言語関連フック
├── context/             # Contextプロバイダー
│   ├── AuthContext.jsx
│   └── CartContext.jsx
├── services/            # API通信サービス
│   ├── api.js
│   ├── authService.js
│   ├── productService.js
│   └── orderService.js
├── i18n/                # 🆕 多言語対応設定
│   ├── index.js         # i18n初期化設定
│   └── config.js        # 言語設定
├── locales/             # 🆕 翻訳ファイル
│   ├── ja/              # 日本語
│   │   ├── common.json
│   │   ├── product.json
│   │   ├── cart.json
│   │   ├── order.json
│   │   └── error.json
│   └── en/              # 英語
│       ├── common.json
│       ├── product.json
│       ├── cart.json
│       ├── order.json
│       └── error.json
├── utils/               # ユーティリティ関数
│   ├── formatters.js
│   └── localeFormatters.js  # 🆕 ロケール別フォーマッター
├── App.jsx
├── main.jsx
└── index.css
```

### 2.2 画面遷移図

```
                    ┌─────────────┐
                    │  ログイン画面  │
                    │  (SCR-001)  │
                    └──────┬──────┘
                           │ ログイン成功
                           ▼
                    ┌─────────────┐
            ┌───────│ 商品一覧画面  │───────┐
            │       │  (SCR-002)  │       │
            │       └──────┬──────┘       │
            │              │              │
            │     商品クリック│              │ カートアイコン
            │              ▼              │
            │       ┌─────────────┐       │
            │       │ 商品詳細画面  │       │
            │       │  (SCR-003)  │       │
            │       └──────┬──────┘       │
            │              │              │
            │   カートに追加 │              │
            │              ▼              ▼
            │       ┌─────────────────────┐
            └──────►│     カート画面       │
                    │     (SCR-004)       │
                    └──────────┬──────────┘
                               │ 注文へ進む
                               ▼
                    ┌─────────────────────┐
                    │    注文確認画面      │
                    │     (SCR-005)       │
                    └──────────┬──────────┘
                               │ 注文確定
                               ▼
                    ┌─────────────────────┐
                    │    注文完了画面      │
                    │     (SCR-006)       │
                    └─────────────────────┘

    ※ ヘッダーから注文履歴画面 (SCR-007) へ遷移可能
    ※ 🆕 ヘッダーの言語切り替えは全画面で利用可能
```

### 2.3 状態管理設計

```
┌────────────────────────────────────────────────────────┐
│                    App (Root)                          │
│  ┌──────────────────────────────────────────────────┐ │
│  │              I18nextProvider                      │ │  🆕
│  │  ┌────────────────────────────────────────────┐  │ │
│  │  │          AuthContext.Provider              │  │ │
│  │  │  ┌──────────────────────────────────────┐  │  │ │
│  │  │  │        CartContext.Provider          │  │  │ │
│  │  │  │  ┌────────────────────────────────┐  │  │  │ │
│  │  │  │  │         Router / Pages         │  │  │  │ │
│  │  │  │  └────────────────────────────────┘  │  │  │ │
│  │  │  └──────────────────────────────────────┘  │  │ │
│  │  └────────────────────────────────────────────┘  │ │
│  └──────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────┘

AuthContext:
  - user: ログインユーザー情報
  - isAuthenticated: 認証状態
  - login(): ログイン処理
  - logout(): ログアウト処理

CartContext:
  - items: カート内商品リスト
  - totalAmount: 合計金額
  - addItem(): 商品追加
  - removeItem(): 商品削除
  - updateQuantity(): 数量更新
  - clearCart(): カートクリア

🆕 i18n (react-i18next):
  - language: 現在の言語 ('ja' | 'en')
  - t(): 翻訳関数
  - changeLanguage(): 言語切り替え
  - i18n.language: 現在の言語コード
```

### 2.4 多言語対応アーキテクチャ 🆕

```
┌────────────────────────────────────────────────────────────┐
│                    i18n Architecture                       │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │
│  │  Browser    │───►│  i18next    │───►│ Translation │   │
│  │  Language   │    │  Detector   │    │   Files     │   │
│  │  Detection  │    │             │    │  (JSON)     │   │
│  └─────────────┘    └─────────────┘    └─────────────┘   │
│                            │                              │
│                            ▼                              │
│  ┌──────────────────────────────────────────────────┐    │
│  │              react-i18next                        │    │
│  │  ┌────────────────┐  ┌────────────────────────┐  │    │
│  │  │ useTranslation │  │ Trans Component        │  │    │
│  │  │     Hook       │  │ (JSX内翻訳)             │  │    │
│  │  └────────────────┘  └────────────────────────┘  │    │
│  └──────────────────────────────────────────────────┘    │
│                            │                              │
│                            ▼                              │
│  ┌──────────────────────────────────────────────────┐    │
│  │              React Components                     │    │
│  │  {t('common:button.addToCart')}                  │    │
│  │  {t('product:detail.description')}               │    │
│  └──────────────────────────────────────────────────┘    │
│                                                            │
└────────────────────────────────────────────────────────────┘

翻訳ファイル構造:
┌─────────────────────────────────────────────────────────────┐
│ src/locales/                                                │
│ ├── ja/                          # 日本語                   │
│ │   ├── common.json              # 共通UI（ナビ、ボタン等）  │
│ │   ├── product.json             # 商品関連                 │
│ │   ├── cart.json                # カート関連               │
│ │   ├── order.json               # 注文関連                 │
│ │   └── error.json               # エラーメッセージ          │
│ └── en/                          # 英語                     │
│     ├── common.json                                         │
│     ├── product.json                                        │
│     ├── cart.json                                           │
│     ├── order.json                                          │
│     └── error.json                                          │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 言語検出・切り替えフロー 🆕

```
┌─────────────────────────────────────────────────────────────┐
│                   言語検出フロー（初回アクセス時）            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ユーザーアクセス                                            │
│        │                                                    │
│        ▼                                                    │
│  ┌───────────────────┐                                      │
│  │ LocalStorage確認   │                                      │
│  │ (保存された言語)   │                                      │
│  └─────────┬─────────┘                                      │
│            │                                                │
│    ┌───────┴───────┐                                        │
│    │存在する?       │                                        │
│    └───────┬───────┘                                        │
│      Yes   │   No                                           │
│        ┌───┴───┐                                            │
│        ▼       ▼                                            │
│  ┌──────────┐ ┌───────────────┐                            │
│  │保存言語を │ │ブラウザ言語を  │                            │
│  │  適用    │ │   検出        │                            │
│  └──────────┘ └───────┬───────┘                            │
│                       │                                     │
│               ┌───────┴───────┐                             │
│               │対応言語?       │                             │
│               │(ja/en)        │                             │
│               └───────┬───────┘                             │
│                 Yes   │   No                                │
│                   ┌───┴───┐                                 │
│                   ▼       ▼                                 │
│             ┌──────────┐ ┌──────────┐                      │
│             │検出言語を │ │デフォルト │                      │
│             │  適用    │ │(ja)を適用 │                      │
│             └──────────┘ └──────────┘                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   言語切り替えフロー                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ユーザーが言語選択                                          │
│        │                                                    │
│        ▼                                                    │
│  ┌───────────────────┐                                      │
│  │ i18n.changeLanguage()                                    │
│  │ 実行               │                                      │
│  └─────────┬─────────┘                                      │
│            │                                                │
│            ├──────────────────┐                             │
│            ▼                  ▼                             │
│  ┌───────────────┐  ┌───────────────────┐                  │
│  │ LocalStorage  │  │ 翻訳テキスト再取得  │                  │
│  │ に言語を保存   │  │ (自動)            │                  │
│  └───────────────┘  └─────────┬─────────┘                  │
│                               │                             │
│                               ▼                             │
│                    ┌───────────────────┐                   │
│                    │ Reactコンポーネント │                   │
│                    │ 自動再レンダリング  │                   │
│                    │ (ページリロード不要)│                   │
│                    └───────────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. バックエンド設計

### 3.1 ディレクトリ構成

```
server/
├── index.js             # エントリーポイント
├── routes/              # ルート定義
│   ├── authRoutes.js
│   ├── productRoutes.js
│   ├── cartRoutes.js
│   └── orderRoutes.js
├── controllers/         # コントローラー
│   ├── authController.js
│   ├── productController.js
│   ├── cartController.js
│   └── orderController.js
├── services/            # ビジネスロジック
│   ├── authService.js
│   ├── productService.js
│   ├── cartService.js
│   └── orderService.js
├── data/                # ダミーデータ
│   ├── users.json
│   ├── products.json       # 🆕 多言語商品データ
│   └── categories.json     # 🆕 多言語カテゴリデータ
├── store/               # インメモリストア
│   └── dataStore.js
└── middleware/          # ミドルウェア
    ├── authMiddleware.js
    └── localeMiddleware.js  # 🆕 言語処理ミドルウェア
```

### 3.2 API エンドポイント一覧

#### 認証 API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| GET | /api/auth/me | 現在のユーザー情報取得 |

#### 商品 API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/products | 商品一覧取得（🆕 `lang`クエリ対応） |
| GET | /api/products/:id | 商品詳細取得（🆕 `lang`クエリ対応） |
| GET | /api/categories | カテゴリ一覧取得（🆕 `lang`クエリ対応） |

#### カート API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/cart | カート内容取得 |
| POST | /api/cart/items | 商品をカートに追加 |
| PUT | /api/cart/items/:productId | カート内商品の数量変更 |
| DELETE | /api/cart/items/:productId | カートから商品削除 |
| DELETE | /api/cart | カートクリア |

#### 注文 API

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | /api/orders | 注文履歴取得 |
| GET | /api/orders/:id | 注文詳細取得 |
| POST | /api/orders | 注文作成 |

### 3.3 多言語対応API仕様 🆕

#### クエリパラメータによる言語指定

```
GET /api/products?lang=en
GET /api/products/:id?lang=ja
GET /api/categories?lang=en
```

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| lang | string | ja | 言語コード（ja, en） |

#### Accept-Languageヘッダー対応

```
Accept-Language: en-US,en;q=0.9,ja;q=0.8
```

**優先順位:**
1. クエリパラメータ `?lang=xx`
2. Accept-Language ヘッダー
3. デフォルト言語（ja）

---

## 4. データ設計

### 4.1 インメモリデータストア構造

```javascript
DataStore = {
  users: [],           // ユーザーデータ
  products: [],        // 商品データ（🆕 多言語対応）
  categories: [],      // カテゴリデータ（🆕 多言語対応）
  carts: {},           // ユーザーごとのカート { userId: CartData }
  orders: []           // 注文データ
}
```

### 4.2 多言語データ構造 🆕

```javascript
// 商品データの多言語構造
Product = {
  id: "prod-001",
  name: {
    ja: "Intel Core i9-14900K",
    en: "Intel Core i9-14900K"
  },
  description: {
    ja: "第14世代Intel Coreプロセッサー。24コア/32スレッドの最高峰CPU。",
    en: "14th Gen Intel Core Processor. Top-tier CPU with 24 cores/32 threads."
  },
  categoryId: "cat-001",
  price: 89800,
  stock: 15,
  // ... その他のフィールド
}

// カテゴリデータの多言語構造
Category = {
  id: "cat-001",
  name: {
    ja: "CPU",
    en: "CPU"
  },
  description: {
    ja: "プロセッサー",
    en: "Processor"
  }
}
```

### 4.3 データ初期化フロー

```
アプリケーション起動
        │
        ▼
┌───────────────────┐
│ ダミーデータ読み込み │
│  (JSON ファイル)   │
│  🆕 多言語データ含む │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│ DataStore に格納   │
│  (メモリ上)        │
└─────────┬─────────┘
          │
          ▼
┌───────────────────┐
│  サーバー起動完了   │
└───────────────────┘

        ...

アプリケーション終了
        │
        ▼
┌───────────────────┐
│ DataStore 破棄    │
│ (全データフラッシュ) │
└───────────────────┘
```

---

## 5. セキュリティ設計

### 5.1 認証方式

- **セッションベース認証**（簡易実装）
- ログイン時にセッションIDを発行
- セッションはサーバーメモリ上に保持

### 5.2 セキュリティ考慮事項

| 項目 | 対応 |
|------|------|
| CORS | 開発環境のみ許可 |
| 入力バリデーション | 基本的なバリデーション実装 |
| 認証チェック | 要認証APIにミドルウェア適用 |
| **言語パラメータ** | **ホワイトリスト検証（ja, en のみ許可）** |

※ 本アプリはワークショップ・デモ用のため、本番レベルのセキュリティは適用しない

---

## 6. 開発環境

### 6.1 必要なツール

| ツール | 用途 |
|--------|------|
| Node.js 20.x | 実行環境 |
| npm / yarn | パッケージ管理 |
| VS Code | エディタ |

### 6.2 追加パッケージ（多言語対応） 🆕

```bash
# i18n関連
npm install i18next react-i18next i18next-browser-languagedetector
```

### 6.3 起動方法

```bash
# フロントエンド開発サーバー
npm run dev

# バックエンドサーバー
npm run server

# 同時起動（concurrently使用）
npm run start
```

---

## 7. 翻訳ファイル設計 🆕

### 7.1 名前空間設計

| 名前空間 | 用途 | 例 |
|---------|------|-----|
| common | 共通UI要素 | ナビゲーション、ボタン、共通ラベル |
| product | 商品関連 | 商品一覧、詳細、フィルター |
| cart | カート関連 | カート画面、数量変更 |
| order | 注文関連 | 注文確認、履歴、完了 |
| error | エラーメッセージ | バリデーション、システムエラー |

### 7.2 翻訳キー命名規則

```
{名前空間}:{カテゴリ}.{要素}.{状態}

例:
- common:nav.home
- common:button.addToCart
- product:list.title
- product:detail.addToCartSuccess
- cart:summary.totalAmount
- error:validation.required
- error:stock.insufficient
```

### 7.3 翻訳ファイル例

**common.json (日本語)**
```json
{
  "nav": {
    "home": "ホーム",
    "products": "商品一覧",
    "cart": "カート",
    "orders": "注文履歴",
    "logout": "ログアウト"
  },
  "button": {
    "addToCart": "カートに追加",
    "checkout": "購入手続きへ",
    "confirm": "確定",
    "cancel": "キャンセル",
    "back": "戻る"
  },
  "label": {
    "price": "価格",
    "quantity": "数量",
    "total": "合計",
    "stock": "在庫"
  }
}
```

**common.json (英語)**
```json
{
  "nav": {
    "home": "Home",
    "products": "Products",
    "cart": "Cart",
    "orders": "Order History",
    "logout": "Logout"
  },
  "button": {
    "addToCart": "Add to Cart",
    "checkout": "Proceed to Checkout",
    "confirm": "Confirm",
    "cancel": "Cancel",
    "back": "Back"
  },
  "label": {
    "price": "Price",
    "quantity": "Quantity",
    "total": "Total",
    "stock": "Stock"
  }
}
```
